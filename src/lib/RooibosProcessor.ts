import * as Debug from 'debug';

import FileDescriptor from './FileDescriptor';
import FunctionMap from './FunctionMap';
import { RuntimeConfig } from './RuntimeConfig';

const debug = Debug('RooibosProcessor');

export class RooibosProcessor {
  constructor(testsPath: string, rootPath: string, outputPath: string) {
    if (!testsPath) {
      throw new Error('testsPath is empty');
    }
    this._testsPath = testsPath;
    this._rootPath = rootPath;
    this._outputPath = outputPath || this._rootPath;
    this._warnings = [];
    this._errors = [];
    this._mapFilename = `rooibosFunctionMap.brs`;
  }

  private readonly _testsPath: string;
  private readonly _rootPath: string;
  private readonly _outputPath: string;
  private readonly _mapFilename: string;
  private readonly _warnings: string[];
  private readonly _errors: string[];

  public runtimeConfig: RuntimeConfig;

  get errors(): string[] {
    return this._errors;
  }

  get warnings(): string[] {
    return this._warnings;
  }

  get testsPath(): string {
    return this._testsPath;
  }

  public processFiles() {
    debug(`Running processor at path ${this.testsPath} `);

    let outputText = this.createFileHeaderText();
    let functionMap = new FunctionMap();

    debug(`Adding runtimeConfig `);
    this.runtimeConfig = new RuntimeConfig(functionMap);
    this.runtimeConfig.processPath(this.testsPath, this._rootPath);

    debug(`Adding function map `);
    outputText += '\n' + functionMap.getFunctionMapText();

    outputText += '\n' + this.createTestsHeaderText();
    outputText += '\n' + this.runtimeConfig.createTestSuiteLookupFunction();
    outputText += '\n' + this.createFileFooterText();

    const file = new FileDescriptor(this._outputPath, this._mapFilename, '.brs');
    file.setFileContents(outputText);
    debug(`Writing to ${file.fullPath}`);
    file.saveFileContents();

    this.errors.concat(this.runtimeConfig.errors);
    this.warnings.concat(this.runtimeConfig.warnings);
    this.reportErrors();
    this.reportWarnings();
  }

  public reportErrors() {
    if (this.errors.length > 0) {

      debug(`
    The following errors occurred during processing:

    ======
    `);
      this.errors.forEach( (errorText) => debug(`[ERROR] ${errorText}`));
      debug(`
    ======
    `);
    }
  }

  public reportWarnings() {
    if (this.warnings.length > 0) {

      debug(`
    The following warnings occurred during processing:

    ======
    `);
      this.warnings.forEach( (errorText) => debug(`[WARN] ${errorText}`));
      debug(`
    ======
    `);
    }
  }

  public createFileHeaderText(): string {
    return `
    '***************************************************
    ' This file is generated by rooibos. DO NOT EDIT. RTM please :)
    ' ***************************************************
    `;
  }

  public createFileFooterText(): string {
    return `

    '***************************************************
    ' This file is generated by rooibos. DO NOT EDIT. RTM please :)
    ' ***************************************************
    `;
  }

  public createTestsHeaderText(): string {
    return `
    '***************************************************
    ' Unit test suites defitintions
    '***************************************************
    `;
  }
}
